<?xml version="1.0" encoding="UTF-8"?>
<project name="Mashine" basedir="../" default="build" xmlns:antcontrib="antlib:net.sf.antcontrib">

    <taskdef resource="net/sf/antcontrib/antlib.xml">
      <classpath>
        <pathelement location="${basedir}/build/ant-contrib-1.0b3.jar"/>
      </classpath>
    </taskdef>

    <property name="build.dir" value="${basedir}/build" />
    <property name="dist.dir" value="${build.dir}/dist" />
    <property name="logs.dir" value="${build.dir}/logs" />
    <property name="tmp.dir" value="${build.dir}/tmp" />
    <property name="assets.dir" value="${tmp.dir}/public/assets" />
    <property name="theme.dir" value="${tmp.dir}/public/themes/default" />
    <property name="release.version" value="0.1.4" />

    <!-- Prepare directories -->
    <target name="prepare">

        <mkdir dir="${dist.dir}"/>
        <mkdir dir="${logs.dir}"/>

        <delete
            dir="${tmp.dir}"
            includeemptydirs="true"
            verbose="true"
            failonerror="true"
        />
        <mkdir dir="${tmp.dir}"/>

    </target>

    <!-- Copy files to tmp dir -->
    <target name="copy" depends="prepare">

        <copy todir="${tmp.dir}" overwrite="true">
            <fileset dir="${basedir}">
                <include name="data/" />
                <include name="lib/" />
                <include name="public/" />
                <include name="scripts/" />

                <!-- Exclude TinyMCE plugins that we are not using -->
                <exclude name="public/assets/js/tiny_mce/plugins/a**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/b**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/c**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/d**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/e**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/fullpage/" />
                <exclude name="public/assets/js/tiny_mce/plugins/i**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/l**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/m**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/n**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/p**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/sa**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/sp**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/st**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/t**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/v**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/w**/" />
                <exclude name="public/assets/js/tiny_mce/plugins/x**/" />

                <!-- Exclude TinyMCE uncompressed sources and simple theme -->
                <exclude name="public/assets/js/tiny_mce/themes/simple/" />
                <exclude name="public/assets/js/tiny_mce/themes/advanced/editor_template_src.js" />
                <exclude name="public/assets/js/tiny_mce/tiny_mce_src.js" />

                <!-- Exclude dummy media files used for tests -->
                <exclude name="public/media/**" />
            </fileset>
        </copy>

        <!--
        Copy the files that need token replacement separately because if
        we apply filterchain to all files binary files get corrupted.
        -->
        <copy todir="${tmp.dir}" overwrite="true">
            <!-- Replace tokens -->
            <filterchain>
                <replacetokens begintoken="@" endtoken="@">
                    <token key="RELEASE_VERSION" value="${release.version}" />
                </replacetokens>
            </filterchain>
            <fileset dir="${basedir}">
                <include name="etc/" />
                <include name="src/" />
                <exclude name="etc/phpframe.ini" />
            </fileset>
        </copy>

    </target>

    <!-- Minify JavaScript Assets -->
    <target name="minify_js" depends="copy">

        <delete file="${assets.dir}/js/mashine.js" failonerror="true" />
        <delete file="${assets.dir}/js/mashine.user.js" failonerror="true" />

        <foreach target="do_minify_js" param="filename">
            <path>
                <fileset dir="${assets.dir}/js" casesensitive="yes">
                    <include name="jquery/jquery.bundle.min.js"/>
                    <include name="mshn.core.js"/>
                </fileset>
            </path>

            <param name="outfile" value="${assets.dir}/js/mashine.js" />
        </foreach>

        <foreach target="do_minify_js" param="filename">
            <path>
                <fileset dir="${assets.dir}/js" casesensitive="yes">
                    <include name="**/*tinymce*.js"/>
                    <include name="mshn.user.js"/>
                </fileset>
            </path>

            <param name="outfile" value="${assets.dir}/js/mashine.user.js" />
        </foreach>

    </target>

    <!-- This target is called  by target 'minify_js' -->
    <target name="do_minify_js">

        <exec
            executable="java"
            dir="${build.dir}"
            failonerror="on"
            output="${outfile}"
            append="true"
        >
            <arg line="-jar yuicompressor-2.4.2.jar ${filename}" />
            <arg line="--charset utf-8 --type js" />
        </exec>

    </target>

    <target name="minify_css" depends="minify_js">

        <exec
            executable="java"
            dir="${build.dir}"
            failonerror="on"
            output="${assets.dir}/css/mashine.css"
        >
            <arg line="-jar yuicompressor-2.4.2.jar ${assets.dir}/css/mashine.css" />
            <arg line="--charset utf-8 --type css" />
        </exec>

        <exec
            executable="java"
            dir="${build.dir}"
            failonerror="on"
            output="${assets.dir}/css/mashine.user.css"
        >
            <arg line="-jar yuicompressor-2.4.2.jar ${assets.dir}/css/mashine.user.css" />
            <arg line="--charset utf-8 --type css" />
        </exec>

    </target>

    <!-- Minify Theme CSS -->
    <target name="minify_theme_css" depends="minify_css">

        <move
            file="${theme.dir}/css"
            tofile="${theme.dir}/css.tmp"
            overwrite="true"
        />

        <mkdir dir="${theme.dir}/css"/>

        <foreach target="do_minify_css" param="filename">
            <path>
                <fileset dir="${theme.dir}/css.tmp" casesensitive="yes">
                    <include name="**/*.css"/>
                    <exclude name="styles.css"/>
                </fileset>
            </path>
        </foreach>

        <delete
            dir="${theme.dir}/css.tmp"
            includeemptydirs="true"
            verbose="true"
            failonerror="true"
        />

    </target>

    <!-- This target is called  by target 'minify_css' -->
    <target name="do_minify_css">

        <exec
            executable="java"
            dir="${build.dir}"
            failonerror="on"
            output="${theme.dir}/css/styles.css"
            append="true"
        >
            <arg line="-jar yuicompressor-2.4.2.jar ${filename}" />
            <arg line="--charset utf-8 --type css" />
        </exec>

    </target>

    <!-- Create archive for distribution -->
    <target name="tar" depends="minify_theme_css">

        <tar
            basedir="${tmp.dir}"
            destfile="${dist.dir}/${ant.project.name}-${release.version}.tgz"
            compression="gzip"
            excludes="etc/phpframe.ini"
        />

    </target>

    <!-- Upload deliverable to live server -->
    <target name="upload" depends="tar">

        <exec
            executable="scp"
            dir="${dist.dir}"
            failonerror="on"
            output="${logs.dir}/scp.log"
        >
            <arg line="-P 2222 ${ant.project.name}-${release.version}.tgz
                       phpframe@e-noise.com:~/dist/apps/Mashine/ " />
        </exec>

    </target>

    <!-- Build project -->
    <target name="build" depends="prepare, copy, minify_js, minify_css, minify_theme_css, tar, upload" />

</project>

